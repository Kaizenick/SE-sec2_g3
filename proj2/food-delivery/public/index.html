<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>bitecode — Discover</title>

  <!-- CSS/Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{ --accent:#16a34a; --text:#0e0e0e; --muted:#6a6f73; --card:#fff; --radius:16px; }
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:white; color:var(--text); }

    /* Navbar */
    .navbar{ background:#fff!important; border-bottom:1px solid rgba(0,0,0,.06); }
    .brand{ font-weight:800; letter-spacing:.2px; color:#0e0e0e; text-decoration:none }
    .brand .accent{ color:var(--accent); }

    /* Hero */
    .hero img{ height:360px; object-fit:cover; }
    @media (max-width: 576px){ .hero img{ height:220px; } }

    /* Search */
    .search-wrap{ position:relative; }
    .search-wrap .form-control{ padding-left:3rem; padding-right:3rem; border-radius:999px; }
    .search-icon{ position:absolute; left:14px; top:50%; transform:translateY(-50%); opacity:.6; }

    /* Cards */
    .restaurant-card{ border:1px solid #eee; background:#fff; border-radius:16px; overflow:hidden; transition:.2s; height:100%; }
    .restaurant-card:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.08); }
    .restaurant-card .thumb{ height:180px; width:100%; object-fit:cover; }
    .restaurant-card .meta{ color:var(--muted); font-size:.9rem; }
    .section-title{ font-weight:800; }

    /* Cart badge */
    .badge-cart{ position:absolute; top:-6px; right:-6px; background:#dc3545; }

    /* Compact footer */
    footer .link-muted{ color:var(--muted); text-decoration:none; }
    footer .link-muted:hover{ text-decoration:underline; color:#0e0e0e; }
  </style>

  <!-- OPTIONAL: set API port for dev -->
  <script>
    // If your API runs on another port, uncomment and adjust:
    // window.API_BASE = "http://localhost:3001/api";
  </script>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar sticky-top">
    <div class="container py-2">
      <a class="navbar-brand brand" href="/index.html">bite<span class="accent">code</span></a>
      <div class="d-flex align-items-center gap-2 ms-auto">
        <a class="btn btn-outline-secondary rounded-pill" href="/orders.html">My Orders</a>
        <a class="position-relative btn btn-outline-primary rounded-pill" href="/cart.html" id="cartLink">
          <span class="me-1">Cart</span>
          <span class="position-absolute translate-middle badge rounded-pill badge-cart" id="cartCount" style="display:none;">0</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- HERO CAROUSEL -->
  <div id="heroCarousel" class="carousel slide hero" data-bs-ride="carousel" data-bs-interval="3500">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt="Fresh salad">
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt="Burgers">
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt="Sushi">
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1543353071-10c8ba85a904?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt="Pasta">
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1546554137-f86b9593a222?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt="Dessert">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span>
    </button>
  </div>

  <main class="container py-4">
    <!-- SEARCH -->
    <div class="search-wrap mb-4">
      <svg class="search-icon" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z" stroke="#000" stroke-opacity=".4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <input id="search" class="form-control" placeholder="Search restaurants or cuisine…">
    </div>

    <!-- SECTION HEADER -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="section-title h4 mb-0">Popular near you</h2>
      <button id="toggleViewBtn" class="btn btn-link">View all</button>
    </div>

    <!-- GRID -->
    <div id="grid" class="row g-3"></div>
  </main>

  <!-- COMPACT FOOTER -->
  <footer class="mt-4 border-top bg-white">
    <div class="container py-3">
      <div class="row gy-3 align-items-center">
        <div class="col-12 col-md">
          <a class="navbar-brand brand d-inline-block me-3" href="/index.html">
            bite<span class="accent">code</span>
          </a>
          <span class="small text-muted">© <span id="yearFooter"></span> bitecode</span>
        </div>
        <div class="col-6 col-md-auto">
          <ul class="list-unstyled small mb-0 d-flex gap-3">
            <li><a class="link-muted" href="/about-us.html">About</a></li>
            <li><a class="link-muted" href="/copyright.html">Copyright</a></li>
            <li><a class="link-muted" href="mailto:support@bitecode.dev">Contact</a></li>
          </ul>
        </div>
        <div class="col-6 col-md-auto text-md-end">
  <ul class="list-unstyled small mb-0 d-flex gap-3">
    <li>
      <a class="link-muted" href="https://www.instagram.com/yourhandle" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
        <i class="bi bi-instagram fs-5"></i>
      </a>
    </li>
    <li>
      <a class="link-muted" href="https://x.com/yourhandle" target="_blank" rel="noopener" aria-label="Twitter/X" title="Twitter/X">
        <i class="bi bi-twitter-x fs-5"></i>
      </a>
    </li>
    <li>
      <a class="link-muted" href="https://facebook.com/yourhandle" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
        <i class="bi bi-facebook fs-5"></i>
      </a>
    </li>
  </ul>
</div>

  </footer>

  <!-- JS -->
  <script>
    // API base
    const API_BASE = (window.API_BASE || (location.origin + "/api"));

    // Elements
    const grid = document.getElementById('grid');
    const searchInput = document.getElementById('search');
    const toggleBtn = document.getElementById('toggleViewBtn');
    const cartCountEl = document.getElementById('cartCount');
    document.getElementById('yearFooter').textContent = new Date().getFullYear();

    let allRestaurants = [];
    let showAll = false;

    // Helpers
    function showGridMessage(text){
      grid.innerHTML = `<div class="col-12 text-center text-muted py-5">${text}</div>`;
    }

    async function fetchRestaurants(query=""){
      const params = query ? ('?q=' + encodeURIComponent(query)) : '';
      try{
        const res = await fetch(`${API_BASE}/restaurants${params}`, { credentials: 'include' });
        if(!res.ok){
          console.warn('Failed to load restaurants', res.status);
          showGridMessage('Could not load restaurants. Try again.');
          return [];
        }
        const data = await res.json();
        if(!Array.isArray(data)) {
          showGridMessage('Unexpected response from server.');
          return [];
        }
        return data;
      }catch(err){
        console.error(err);
        showGridMessage('Network error. Check your server and try again.');
        return [];
      }
    }

    function render(restaurants){
      grid.innerHTML = "";
      const list = showAll ? restaurants : restaurants.slice(0, 10);

      if(!list.length){
        showGridMessage('No restaurants found.');
        toggleBtn.style.visibility = 'hidden';
        return;
      }

      for(const r of list){
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-lg-4';

        const fee = (typeof r.deliveryFee === 'number') ? r.deliveryFee.toFixed(2) : '0.00';
        const rating = (typeof r.rating === 'number') ? r.rating.toFixed(1) : (r.rating || '4.6');
        const img = r.imageUrl || '/assets/placeholder-restaurant.jpg';

        col.innerHTML = `
          <a href="/restaurant.html?id=${encodeURIComponent(r._id)}" class="text-decoration-none text-reset">
            <div class="restaurant-card">
              <img class="thumb"
                   src="${img}"
                   alt="${r.name}"
                   loading="lazy"
                   onerror="this.onerror=null; this.src='/assets/placeholder-restaurant.jpg';">
              <div class="p-3">
                <div class="d-flex justify-content-between">
                  <div class="fw-semibold">${r.name}</div>
                  <div class="text-muted small">⭐ ${rating}</div>
                </div>
                <div class="meta">${r.cuisine || 'Food'} • $${fee} delivery</div>
              </div>
            </div>
          </a>
        `;
        grid.appendChild(col);
      }

      if (restaurants.length > 10) {
        toggleBtn.style.visibility = 'visible';
        toggleBtn.textContent = showAll ? 'Show less' : `View all (${restaurants.length})`;
      } else {
        toggleBtn.style.visibility = 'hidden';
      }
    }

    // Search (debounced)
    let searchDebounce;
    searchInput.addEventListener('input', ()=>{
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(async ()=>{
        const q = searchInput.value.trim();
        const data = await fetchRestaurants(q);
        allRestaurants = data;
        showAll = false;
        render(allRestaurants);
      }, 250);
    });

    // Toggle View all
    toggleBtn.addEventListener('click', ()=>{
      showAll = !showAll;
      render(allRestaurants);
    });

    // Cart badge (API first, fallback to localStorage)
    async function updateCartCount(){
      try{
        const res = await fetch(`${API_BASE}/cart`, { credentials: 'include' });
        if (res.ok){
          const data = await res.json();
          const count = Array.isArray(data) ? data.length :
                        Array.isArray(data?.items) ? data.items.length : 0;
          setCartBadge(count); return;
        }
      }catch(e){}
      try{
        const local = JSON.parse(localStorage.getItem('cart') || '[]');
        setCartBadge(Array.isArray(local) ? local.length : 0);
      }catch(e){ setCartBadge(0); }
    }
    function setCartBadge(n){
      if (n > 0){ cartCountEl.textContent = n; cartCountEl.style.display = 'inline-block'; }
      else { cartCountEl.style.display = 'none'; }
    }

    // Init
    (async function init(){
      const data = await fetchRestaurants();
      // console.log('restaurants:', data);
      allRestaurants = data;
      render(allRestaurants);
      updateCartCount();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
